# Setting up a Raspberry Pi 4 RAK7244 based LoRa gateway/concentrator

## Bibliography

* RAK7244 LPWAN Developer gateway : <https://doc.rakwireless.com/rak7244-lorawan-developer-gateway/overview>

* RAK7244 Quick Start Guide : <https://doc.rakwireless.com/rak7244-lorawan-developer-gateway/quick-start-guide>

* The Thing Network : <https://www.thethingsnetwork.org/docs/gateways/rak2245/>

* RAK2245 software : <https://github.com/RAKWireless/rak_common_for_gateway>

* RAK2245 datasheet : <https://doc.rakwireless.com/datasheet/rakproducts/rak2245-pi-hat-datasheet>

## Setup

1. First, download a fresh copy of [Raspberry Pi OS](https://www.raspberrypi.org/downloads/raspbian/)

Follow this tutorial to configure quickly a headless Raspberry over WiFi : <https://medium.com/plynth/raspberry-pi-4-configuration-for-iot-projects-quick-and-easy-headless-setup-over-wifi-e9631f07e760>

Use software like `Advanced IP Scanner` to locate the IP of your Raspberry when it first boots.

As usual don't forget to :

* Change th default `pi` user password (or better [remove it](https://www.bennettnotes.com/delete-pi-user-on-raspberry-pi/))

Add a new user `fred` : <https://www.raspberrypi.org/documentation/linux/usage/users.md>

* Update your distribution

```bash
sudo apt-get update && sudo apt-get upgrade
```

* Change DHCP configuration if you want a static IP (below a configuration sample for the `wlan0` interface)

```bash
interface wlan0
static ip_address=192.168.1.8/24
static routers=192.168.1.1
static domain_name_servers=192.168.1.27
```

* Check `/etc/resolv.conf` file if you use a custom DNS server

Mine looks like

```bash
# Generated by resolvconf
nameserver 192.168.1.27
```

* Change hostname, TZ, `pi` user password, enable SPI, I2C interface, Expand filesystem, using `raspi-config`

2. Installing `LoRa gateway` and `Packet forwarder`

We are using this repository : <https://github.com/RAKWireless/rak_common_for_gateway>

Note : this repository is using <https://github.com/Lora-net> to fetch `LoRa gateway` and `packet forwarder` software.

```bash
#Create applications folder in fred's home directory
mkdir -p applications
cd applications
#Install git 
sudo apt install git
#Cloning LoRa gateway repository
git clone https://github.com/RAKWireless/rak_common_for_gateway
cd rak_common_for_gateway/
#Checking out last tags 4.2.0 as of 05/2020
git checkout tags/4.2.0 -b v4.2.0
#Install (don't install chirpstack)
sudo ./install.sh --chirpstack=not_install
```

Reboot your raspberry

3. Configuring the LoRaWAN gateway/concentrator

It is possible to configure the gateway so LoraWAN packet are forwarded to the Thing Network or ChirpStack server (called LoRa server formely)

```bash
sudo gateway-config
```

```bash
gateway-version
```

Sample output

```bash
Raspberry Pi 4 Model B Rev 1.1, OS "10 (buster)", 4.19.118-v7l+.
RAKWireless gateway RAK2245 version 4.2.0R install from source code.
Gateway ID: DCA632FFFE365D9C.
```

Checking GPS

```bash
sudo cat /dev/ttyAMA0
```

Sample output

```bash
,298,28,29,59,05PGLL,48064672,E,110134.00,A,A*6A
B$GPRMC,174960,N,00153.64675,E,0.301,,310TG,,T,,M,0.301,N,0.557,K,A*26
$4805.74960,N,00153.64675,E,1,08,4,M,,*58
$GPGSA05,31,26,04,18,21,25,,,,09
$GPGSV,3,1,110,319,16,05,12,059,18,12,02,109,2,12,14,03,226,25,16,15,293,,18,179,36*7E
```

The packet forwarder can be restarted with the following command :

```bash
sudo systemctl stop ttn-gateway
sudo systemctl start ttn-gateway

##Log
sudo journalctl -f -n 100 -u ttn-gateway
```

4. Setting up `ChirpStack Packet Multiplexer`

The ChirpStack Packet Multiplexer utility forwards the Semtech packet-forwarder UDP data to multiple endpoints. It makes it possible to connect a single LoRa gateway to multiple networks. It is part of ChirpStack.

Installation is straightforward via the Debian packet system

See : <https://github.com/brocaar/chirpstack-packet-multiplexer>

Some useful information:

The configuration file is located at: `/etc/chirpstack-packet-multiplexer/chirpstack-packet-multiplexer.toml`

Some helpful commands for chirpstack-packet-multiplexer:

```bash
#Start:
sudo systemctl start chirpstack-packet-multiplexer

#Restart:
sudo systemctl restart chirpstack-packet-multiplexer

#Stop:
sudo systemctl stop chirpstack-packet-multiplexer

#Display logs:
sudo journalctl -f -n 100 -u chirpstack-packet-multiplexer
```

5. Using `ChirpStack Packet Multiplexer` 

Create a `ChirpStack Packet Multiplexer` configuration file

Located at `/etc/chirpstack-packet-multiplexer/chirpstack-packet-multiplexer.toml`

```bash
[general]
# Log level
#
# debug=5, info=4, warning=3, error=2, fatal=1, panic=0
log_level=4


[packet_multiplexer]
# Bind
#
# The interface:port on which the packet-multiplexer will bind for receiving
# data from the packet-forwarder (UDP data).
bind="0.0.0.0:1700"

# Backends
#
# The backends to which the packet-multiplexer will forward the
# packet-forwarder UDP data.
#
# This sends the same traffic from the packet forwarder to TTN
[[packet_multiplexer.backend]]
# Host
#
# The host:IP of the backend.
host="router.eu.thethings.network:1700"
#
# Uplink only
#
# This backend is for uplink only. It is not able to send data
# back to the gateways.
uplink_only=false
#
# Gateway IDs
#
# The Gateway IDs to forward data for.
gateway_ids = [
  "XXXXXXX"
]

#
# ChirpStack Gateway Brigge
#
[[packet_multiplexer.backend]]
# Host
#
# TTN Address
host="127.0.0.1:1800"
#
# Uplink only
#
# This backend is for uplink only. It is not able to send data
# back to the gateways.
uplink_only=false
#
# Gateway IDs
#
# The Gateway IDs to forward data for.
gateway_ids = [
  "XXXXXXX"
]
```

Modify packet forwarder configuration file (located at `/opt/ttn-gateway/packet_forwarder/lora_pkt_fwd/global_conf.json`)

```bash
#Address of the ChirpStack Multiplexer
"server_address": "127.0.0.1"
```

6. Setting up `ChirpStack Gateway Bridge`

ChirpStack Gateway Bridge is a service which converts LoRa® Packet Forwarder protocols into a ChirpStack Network Server common data-format (JSON and Protobuf). This component is part of the ChirpStack open-source LoRaWAN® Network Server stack.

Installation is straightforward via the Debian packet system

See : <https://www.chirpstack.io/gateway-bridge/install/debian/>

The configuration file is located at: `/etc/chirpstack-gateway-bridge/chirpstack-gateway-bridge.toml`

Some useful commands :

```bash
#Start:
sudo systemctl start chirpstack-gateway-bridge

#Restart:
sudo systemctl restart chirpstack-gateway-bridge

#Stop:
sudo systemctl stop chirpstack-gateway-bridge

#Display logs:
sudo journalctl -f -n 100 -u chirpstack-gateway-bridge 
```

7. Using `ChirpStack Gateway Bridge` to forward LoRa message to MQTT

First we need to edit the config file (which is not available by default)
The config file is located here : `/etc/chirpstack-gateway-bridge/chirpstack-gateway-bridge.toml`

```bash
sudo chmod o+rx /etc/chirpstack-gateway-bridge
```

```bash
# This configuration provides a Semtech UDP packet-forwarder backend and
# integrates with a MQTT broker. Many options and defaults have been omitted
# for simplicity.
#
# See https://www.chirpstack.io/gateway-bridge/install/config/ for a full
# configuration example and documentation.


# Gateway backend configuration.
[backend]
# Backend type.
type="semtech_udp"

  # Semtech UDP packet-forwarder backend.
  [backend.semtech_udp]

  # ip:port to bind the UDP listener to
  #
  # Example: 0.0.0.0:1700 to listen on port 1700 for all network interfaces.
  # This is the listener to which the packet-forwarder forwards its data
  # so make sure the 'serv_port_up' and 'serv_port_down' from your
  # packet-forwarder matches this port.
  udp_bind = "0.0.0.0:1800"


# Integration configuration.
[integration]
# Payload marshaler.
#
# This defines how the MQTT payloads are encoded. Valid options are:
# * protobuf:  Protobuf encoding
# * json:      JSON encoding (easier for debugging, but less compact than 'protobuf')
marshaler="json"

  # MQTT integration configuration.
  [integration.mqtt]
  # Event topic template.
  event_topic_template="gateway/{{ .GatewayID }}/event/{{ .EventType }}"

  # Command topic template.
  command_topic_template="gateway/{{ .GatewayID }}/command/#"

  # MQTT authentication.
  [integration.mqtt.auth]
  # Type defines the MQTT authentication type to use.
  #
  # Set this to the name of one of the sections below.
  type="generic"

    # Generic MQTT authentication.
    [integration.mqtt.auth.generic]
    # MQTT server (e.g. scheme://host:port where scheme is tcp, ssl or ws)
    server="tcp://mqtt.guiet.lan:1883"

    # Connect with the given username (optional)
    username=""

    # Connect with the given password (optional)
    password=""
```

8. Final topology

LoRa Packet Forwarder == Port 1700 ==> ChirpStack Packet Multiplexer == Port 1700 ==> TTN 
            == Pport 1800 ==> ChirpStack Gateway Bridge == 1883 ==> Local MQTT Broker

9. Decoding LoRa packet received on MQTT broker

MQTT Message will look as follow:

```bash
gateway/dca632fffe365d9c/event/up {"phyPayload":"QE4TASaAQAABj9Nurw0r74yfOu320Ph5QeI=","txInfo":{"frequency":868300000,"modulation":"LORA","loRaModulationInfo":{"bandwidth":125,"spreadingFactor":7,"codeRate":"4/5","polarizationInversion":false}},"rxInfo":{"gatewayID":"3KYy//42XZw=","time":"2020-05-31T16:29:34.326328Z","timeSinceGPSEpoch":"1274977793.326s","rssi":-29,"loRaSNR":9,"channel":1,"rfChain":1,"board":0,"antenna":0,"location":null,"fineTimestampType":"NONE","context":"oQG3Qw==","uplinkID":"NITlrj9USi2JS061B0D2jQ==","crcStatus":"CRC_OK"}}
```

If you want to decode the payload `QE4TASaAQAABj9Nurw0r74yfOu320Ph5QeI=`, one can go : <https://lorawan-packet-decoder-0ta6puiniaut.runkit.sh/>

Or you can install this tool : <https://github.com/anthonykirby/lora-packet>
